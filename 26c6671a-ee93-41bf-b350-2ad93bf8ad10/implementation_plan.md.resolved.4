# Docling Pipeline - Implementation Plan

## Architecture

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ ingest-api  │────▶│   Redis     │────▶│docling-worker│
│  (FastAPI)  │     │  (queues)   │     │  (parse)     │
└─────────────┘     └─────────────┘     └──────┬───────┘
                                               │
                    ┌─────────────┐            ▼
                    │   Qdrant    │◀────┌─────────────┐
                    │  (vectors)  │     │embed-worker │
                    └─────────────┘     │  (chunk)    │
                                        └──────┬──────┘
                                               │
                                        ┌──────▼──────┐
                                        │   Ledger    │
                                        │  (JSONL)    │
                                        └─────────────┘
```

## Directory Structure
```
docling/
├── docker-compose.yml
├── services/
│   ├── ingest-api/
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── main.py
│   ├── docling-worker/
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── worker.py
│   ├── embed-worker/
│   │   ├── Dockerfile
│   │   ├── requirements.txt
│   │   └── worker.py
│   └── ledger/
│       ├── Dockerfile
│       ├── requirements.txt
│       └── ledger.py
├── schemas/
│   ├── doc.normalized.v1.json
│   └── chunk.embedding.v1.json
├── lib/
│   └── jcs.py  # JSON Canonicalization
└── tests/
    ├── test_replay.py
    └── test_integration.py
```

## Key Design Decisions

1. **JCS Canonicalization**: RFC 8785 for deterministic JSON → reproducible hashes.
2. **Hash-Chain Ledger**: Each entry includes `prev_hash` for integrity verification.
3. **Redis Queues**: `docling:pending`, `embed:pending` for async processing.
4. **Qdrant**: Vector storage with metadata for chunk retrieval.

## Verification Strategy
- **Replay Test**: Submit same document twice → assert identical `bundle_id` and hashes.
- **Integration Test**: End-to-end flow from ingest → ledger entry.
