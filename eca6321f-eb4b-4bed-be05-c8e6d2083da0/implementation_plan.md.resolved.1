# Agency Docking Shell Implementation Plan

Build a portable "Hub" for Agentic Field Games that normalizes environmental states into a shared cognitive manifold.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                    Agency Docking Shell                      │
├─────────────────────────────────────────────────────────────┤
│  DockingShell (Hub)                                         │
│    ↓                                                         │
│  Observe → Normalize → Unify → Act                          │
│    ↓           ↓          ↓       ↓                          │
│  TensorField   │      RAG Layer  LLM                         │
│  (Math Core)   │         ↓                                   │
│                │    Docling Pipeline (Vector Store)          │
│                ↓                                             │
│           SpokeAdapter (ABC)                                 │
│                ↓                                             │
│           Field Games (Spokes)                               │
└─────────────────────────────────────────────────────────────┘
```

## Integration Strategy

### Docling Pipeline as RAG Backend
The existing Docling Pipeline provides:
- ✅ Vector embeddings (all-mpnet-base-v2, 768-dim)
- ✅ Qdrant vector store
- ✅ Deterministic hash-anchored storage
- ✅ Document ingestion API

**Connection Point**: TensorField queries Qdrant for RAG unification

---

## Proposed Changes

### Core Components

#### [NEW] [agency_hub/](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/)

Main directory for the Agency Docking Shell.

#### [NEW] [docking_shell.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/docking_shell.py)

Central Hub controller implementing the cognitive cycle:
- `observe()` - Get state from Spoke
- [normalize()](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/pipeline/lib/normalize.py#43-54) - Voxelize via TensorField
- `unify()` - RAG query to Qdrant
- `act()` - LLM synthesis → Token

#### [NEW] [tensor_field.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/tensor_field.py)

Math core for state processing:
- Voxelized state representation (n-dimensional)
- Eigen-embedding for variance normalization
- State → Eigenstate transformation
- Integration with Qdrant for RAG

#### [NEW] [spoke_adapter.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/spoke_adapter.py)

Abstract base class for Field Games:
```python
class SpokeAdapter(ABC):
    @abstractmethod
    def get_state(self) -> np.ndarray
    
    @abstractmethod
    def apply_action(self, token: str) -> None
    
    @abstractmethod
    def reset(self) -> None
```

#### [NEW] [llm_synthesizer.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/llm_synthesizer.py)

LLM integration layer:
- Replace `_synthesize_token` heuristic
- Gemini API integration
- Context: Eigenstate + RAG results → Action token

---

### Field Games (Spokes)

#### [NEW] [spokes/racer_2d5/](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/spokes/racer_2d5/)

2.5D Mario Kart-style racing game:
- Physics engine (position, velocity, acceleration)
- Track representation
- Collision detection
- Implements `SpokeAdapter`

#### [NEW] [spokes/dummy_game.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/spokes/dummy_game.py)

Simple test spoke for verification (already mentioned in your description).

---

### RAG Integration

#### [MODIFY] [rag_client.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/rag_client.py)

Client for Qdrant vector store:
- Query embeddings by similarity
- Integrate with Docling Pipeline's Qdrant instance
- Return top-k knowledge vectors

---

### Deployment

#### [NEW] [docker-compose.yml](file:///c:/Users/eqhsp/.gemini/antigravity/playground/rogue-comet/agency_hub/docker-compose.yml)

Orchestrate all services:
- Agency Hub (DockingShell)
- Docling Pipeline (RAG backend)
- LLM API (Gemini or local)
- Field Game instances

---

## Implementation Phases

### Phase 1: Core Hub (Week 1)
- [ ] Implement `DockingShell` with cognitive cycle
- [ ] Implement `TensorField` (voxelization, eigen-embedding)
- [ ] Implement `SpokeAdapter` ABC
- [ ] Create `DummyFieldGame` for testing

### Phase 2: RAG Integration (Week 1)
- [ ] Connect `TensorField` to Qdrant
- [ ] Implement RAG query logic
- [ ] Seed knowledge base with test concepts
- [ ] Verify Eigenstate → RAG → Knowledge flow

### Phase 3: LLM Integration (Week 2)
- [ ] Replace `_synthesize_token` with Gemini API
- [ ] Implement context construction (Eigenstate + RAG)
- [ ] Add prompt engineering for action synthesis
- [ ] Test end-to-end: State → LLM → Action

### Phase 4: Real Spoke - 2.5D Racer (Week 2-3)
- [ ] Implement physics engine
- [ ] Create track representation
- [ ] Implement `SpokeAdapter` interface
- [ ] Integrate with Hub
- [ ] Visualize game state

### Phase 5: Production Deployment (Week 3-4)
- [ ] Containerize all components
- [ ] Scale RAG with production vector store
- [ ] Add monitoring and logging
- [ ] Performance optimization
- [ ] Documentation

---

## Technical Decisions

### LLM Choice
**Recommended**: Gemini 2.0 Flash
- Fast inference
- Good reasoning
- API available

**Alternative**: Local Llama 3.2 (for offline)

### Vector Store
**Current**: Qdrant (from Docling Pipeline)
**Future**: Consider Pinecone/Weaviate for scale

### State Representation
- **Voxel Grid**: 3D spatial discretization
- **Eigen-Embedding**: PCA-based variance normalization
- **Dimension**: Configurable (start with 64-128 dim)

---

## Success Criteria

✅ **Deterministic Replay**: Same state → same action (with fixed LLM seed)  
✅ **RAG Grounding**: Actions informed by knowledge base  
✅ **Spoke Agnostic**: Multiple games use same Hub  
✅ **LLM Integration**: Real model inference (not heuristic)  
✅ **Containerized**: Docker deployment ready

---

## Next Immediate Steps

1. **Create `agency_hub/` directory structure**
2. **Implement `DockingShell` skeleton**
3. **Implement `TensorField` with Qdrant integration**
4. **Create `DummyFieldGame` spoke**
5. **Test cognitive cycle: Observe → Normalize → Unify → Act**
