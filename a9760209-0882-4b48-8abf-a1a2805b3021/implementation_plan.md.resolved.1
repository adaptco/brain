# Hawkthorne Speedrun Bot - Implementation Plan

## Goal
Build an auto-speedrun bot for Project Hawkthorne using MCP-orchestrated frontier LLM agents and tensor manifold generation for optimal trajectory synthesis.

## User Review Required

> [!IMPORTANT]
> **LÖVE Runtime Injection**: The Lua bridge requires modifying Hawkthorne's `main.lua` to load our observer module. This is non-destructive but requires game source access.

> [!WARNING]
> **LLM API Costs**: The agent cluster uses Gemini API calls per frame/segment. Consider rate limiting for cost control.

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────┐
│              Tensor Manifold (Queen Boo)            │
│         Worldline vectors → Geodesic paths          │
└─────────────────────────────────────────────────────┘
                        ▲
┌─────────────────────────────────────────────────────┐
│              LLM Agent Cluster                      │
│   Planner ─→ Executor ─→ Validator (handoff chain)  │
└─────────────────────────────────────────────────────┘
                        ▲
┌─────────────────────────────────────────────────────┐
│              MCP Action Hub                         │
│   observe | execute | checkpoint | handoff          │
└─────────────────────────────────────────────────────┘
                        ▲
┌─────────────────────────────────────────────────────┐
│        Hawkthorne Bridge (LÖVE/Lua)                 │
│   State Observer │ Input Injector │ IPC Socket      │
└─────────────────────────────────────────────────────┘
```

---

## Phase 1: Game Interface Layer

#### [NEW] hawkthorne_bridge.lua
Lua module injected into LÖVE runtime.

**State Observer** extracts:
- Player position `{x, y}`
- Current level/room ID
- Enemy positions and health
- Collectibles and items
- Timer/frame count

**Input Injector**:
- Programmatic keypresses via `love.keyboard.setKey`
- Frame-perfect action timing

**IPC Socket**:
- JSON-RPC over `localhost:7878`
- Methods: `getState()`, `sendAction(action)`

---

## Phase 2: MCP Action Hub

#### [NEW] mcp_action_server.py

| Endpoint | Purpose |
|----------|---------|
| `observe` | Get current game state JSON |
| [execute(action)](file:///c:/Users/eqhsp/code/adaptco/unified_shell_proto/bridges/io_bridge.py#24-70) | Inject action into game |
| `checkpoint` | Create validation snapshot |
| `handoff(context)` | Pass context to next agent |

**Handoff Protocol**:
```json
{
  "chain": ["navigate:town_hall", "collect:key", "boss:defeat"],
  "worldline_id": "wv_00a1b2c3",
  "context": {"elapsed_frames": 1847, "checkpoints_hit": 3}
}
```

---

## Phase 3: LLM Agent Cluster

#### [NEW] agent_runner.py

| Agent | Model | Responsibility |
|-------|-------|----------------|
| Planner | gemini-2.5-pro | Long-range route optimization |
| Executor | gemini-flash | Frame-by-frame action synthesis |
| Validator | gemini-pro | Checkpoint verification, error recovery |

**Handoff Chain**:
```python
async def run_speedrun():
    plan = await planner.generate_route(game_state)
    for segment in plan.segments:
        actions = await executor.synthesize_actions(segment)
        for action in actions:
            await mcp.execute(action)
        await validator.checkpoint(segment.goal)
```

---

## Phase 4: Tensor Manifold (Queen Boo)

#### [NEW] queen_boo.py

**Worldline Vector Encoding**:
```python
worldline = TensorField.encode(
    positions=trajectory.positions,   # [N, 2]
    actions=trajectory.actions,       # [N, A]
    rewards=trajectory.rewards        # [N]
)
```

**Manifold Synthesis**:
```python
class QueenBoo:
    def __init__(self, worldlines: List[Tensor]):
        self.manifold = self._fit_manifold(worldlines)
    
    def generate_optimal_path(self, start, goal) -> Trajectory:
        return self.manifold.geodesic(start, goal)
```

---

## File Structure

```
hawkthorne_bot/
├── bridge/
│   └── hawkthorne_bridge.lua
├── mcp/
│   ├── action_server.py
│   └── handoff_protocol.py
├── agents/
│   ├── planner.py
│   ├── executor.py
│   ├── validator.py
│   └── runner.py
├── manifold/
│   ├── worldline.py
│   └── queen_boo.py
├── config.toml
└── requirements.txt
```

---

## Verification Plan

### Checkpoints
| Milestone | Target Time |
|-----------|-------------|
| Level 1 Clear | < 30 seconds |
| Boss Room Entry | < 2 minutes |
| Full Run | < 10 minutes |

### Metrics
- Action accuracy vs reference TAS
- Worldline vector convergence (cosine similarity)
- Queen Boo geodesic efficiency
