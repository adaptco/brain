# Goal: Implement Batch Processing for Embed Worker

Integrate high-velocity mechanical enforcement with long-term semantic memory by evolving the `Embed Worker` from single-chunk processing to **Batch Processing**. This maximizes GPU utilization and increases throughput for the Sovereign OS.

## Proposed Changes

### 1. Docling Worker Refactor
#### [MODIFY] [tasks.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/ghost-void/docling-pipeline/services/docling_worker/tasks.py)
- Group chunks created in [create_chunks](file:///c:/Users/eqhsp/.gemini/antigravity/playground/ghost-void/docling-pipeline/services/docling_worker/tasks.py#172-212) into batches (e.g., size 32).
- Enqueue a single job `tasks.embed_batch` for each group, containing a list of chunk payloads.

### 2. Embed Worker Refactor
#### [MODIFY] [worker.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/ghost-void/docling-pipeline/services/embed_worker/worker.py)
- Rename [embed_chunk](file:///c:/Users/eqhsp/.gemini/antigravity/playground/ghost-void/docling-pipeline/services/embed_worker/tasks.py#63-140) to `embed_batch`.
- Modify `get_embeddings` (plural) to accept a list of strings and returned a batched tensor.
- Implement batch normalization and deterministic pseudo-embedding for the entire batch.
- Update Qdrant `upsert` and Ledger `append` to handle multiple records in a single block.

### 3. Task Mapping Consistency
#### [MODIFY] [tasks.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/ghost-void/docling-pipeline/services/embed_worker/tasks.py)
- Reflect the same changes as [worker.py](file:///c:/Users/eqhsp/.gemini/antigravity/playground/ghost-void/docling-pipeline/services/embed_worker/worker.py) to maintain consistency for the Docker container.

## Verification Plan

### Automated Tests
- Modify the `ingress_test.py` (or equivalent) to send a document that generates >32 chunks.
- Verify that only one `embed_batch` job is enqueued in Redis.
- Verify that Qdrant contains all expected points.
- Check Ledger for consecutive "chunk.embedding.v1" events from the same batch.

### Manual Verification
- Monitor Redis queue size during large document ingestion.
- Verify GPU utilization (simulated or real) increases while processing time per chunk decreases.
